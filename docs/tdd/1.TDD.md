# Stok Takip SaaS Projesi - Technical Design Document (TDD)

**Doküman Adı:** Stok Takip SaaS - Technical Design Document  
**Sürüm:** 1.0  
**Tarih:** 23 Haziran 2025  
**Yazar:** Development Team  

## 1. System Architecture

### 1.1 High-Level Architecture

```
┌─────────────────┐    HTTP/HTTPS    ┌─────────────────┐    Entity Framework    ┌─────────────────┐
│                 │ ────────────────► │                 │ ─────────────────────► │                 │
│   Frontend      │                  │   Backend       │                        │   Database      │
│   (MVC)         │                  │   (Web API)     │                        │   (SQL Server)  │
│                 │ ◄──────────────── │                 │ ◄───────────────────── │                 │
└─────────────────┘    JSON/HTML     └─────────────────┘                        └─────────────────┘
        │                                     │                                           │
        │                                     │                                           │
        ▼                                     ▼                                           ▼
┌─────────────────┐                  ┌─────────────────┐                        ┌─────────────────┐
│ Tenant Context  │                  │ Business Logic  │                        │ Shared Database │
│ Resolution      │                  │ + Tenant Filter │                        │ + Tenant ID     │
│ (Subdomain)     │                  │                 │                        │ Isolation       │
└─────────────────┘                  └─────────────────┘                        └─────────────────┘
```

### 1.2 Tech Stack Justification

| Katman | Teknoloji | Justification |
|--------|-----------|---------------|
| **Frontend** | ASP.NET Core MVC 8.0 | Server-side rendering, SEO friendly, hızlı development |
| **Backend API** | ASP.NET Core Web API 8.0 | RESTful API, JSON serialization, performans |
| **ORM** | Entity Framework Core 8.0 | Code-first approach, migration support, LINQ |
| **Database** | SQL Server | Enterprise-grade, güvenilir, .NET ecosystem |
| **Authentication** | JWT + Cookie Hybrid | Stateless API + Web security |
| **Hosting** | Azure App Service | Managed service, auto-scaling, CI/CD |

### 1.3 Multi-Tenancy Architecture

**Pattern:** Shared Database + Tenant ID Discrimination

#### 1.3.1 Tenant Identification Strategy
```csharp
// URL Examples:
// mehmet.stokapp.com → TenantId: "mehmet"
// ayse.stokapp.com → TenantId: "ayse"

public class TenantContext
{
    public string TenantId { get; set; }
    public string TenantName { get; set; }
    public DateTime CreatedAt { get; set; }
    public bool IsActive { get; set; }
}
```

#### 1.3.2 Data Isolation Approach
```csharp
// Her entity'de TenantId mandatory
public abstract class TenantEntity
{
    public string TenantId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
}

// Global Query Filter - otomatik TenantId filtreleme
modelBuilder.Entity<Product>()
    .HasQueryFilter(p => p.TenantId == _currentTenant.TenantId);
```

### 1.4 Application Layers

#### 1.4.1 Presentation Layer (MVC)
- **Sorumluluklar:**
  - Kullanıcı arayüzü rendering
  - Form validation
  - Tenant context management
  - Session management

#### 1.4.2 API Layer (Web API)
- **Sorumluluklar:**
  - RESTful endpoints
  - Business logic orchestration
  - Tenant-aware operations
  - Data validation & authorization

#### 1.4.3 Business Logic Layer
- **Sorumluluklar:**
  - Domain logic implementation
  - Business rules enforcement
  - Service orchestration

#### 1.4.4 Data Access Layer
- **Sorumluluklar:**
  - Entity Framework DbContext
  - Repository pattern implementation
  - Query optimization
  - Automatic TenantId injection

### 1.5 Request Flow

```
1. User → mehmet.stokapp.com/products
2. TenantMiddleware → Extract "mehmet" as TenantId
3. Authentication → Validate user belongs to tenant
4. MVC Controller → Call API endpoint
5. API Controller → Apply tenant context
6. Repository → Apply global query filter
7. Database → Return tenant-specific data
8. Response → JSON/HTML to user
```

### 1.6 Security Architecture

#### 1.6.1 Authentication Flow
```csharp
// Hybrid Authentication
[Authorize]
public class ProductsController : ControllerBase
{
    // JWT for API calls
    // Cookie for MVC pages
}
```

#### 1.6.2 Tenant Security
- Global query filters prevent cross-tenant data access
- Tenant validation in middleware
- API key validation for each tenant
- Row-level security through TenantId

### 1.7 Scalability Considerations

**MVP Scale (10 tenants):**
- Single App Service instance
- Basic SQL Server
- Minimal caching

**Future Scale (100+ tenants):**
- Load balancer + multiple instances
- Database sharding options
- Redis cache layer
- CDN for static assets

---

## 2. Database Design

### 2.1 Entity Relationship Diagram

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     Tenant      │    │      User       │    │    Category     │
│                 │    │                 │    │                 │
│ + Id (PK)       │───►│ + Id (PK)       │    │ + Id (PK)       │
│ + Name          │    │ + TenantId (FK) │    │ + TenantId (FK) │
│ + SubDomain     │    │ + Email         │    │ + Name          │
│ + IsActive      │    │ + Role (Enum)   │    │ + ParentId (FK) │
│ + CreatedAt     │    │ + IsActive      │    │ + IsActive      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                │
                                ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │  RolePermission │    │   Permission    │
                       │                 │    │                 │
                       │ + Id (PK)       │───►│ + Id (PK)       │
                       │ + Role (Enum)   │    │ + TenantId (FK) │
                       │ + PermissionId  │    │ + Name          │
                       │ + TenantId (FK) │    │ + Code          │
                       │                 │    │ + Module        │
                       └─────────────────┘    └─────────────────┘
                                                        │
                                                        │ Self Join
                                                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    Supplier     │    │     Product     │◄───│   Sub Category  │
│                 │    │                 │    │                 │
│ + Id (PK)       │    │ + Id (PK)       │    │ + Id (PK)       │
│ + TenantId (FK) │    │ + TenantId (FK) │    │ + ParentId (FK) │
│ + Name          │    │ + Name          │    │ + Name          │
│ + ContactInfo   │    │ + SKU           │    └─────────────────┘
│ + Notes         │    │ + Barcode       │
│ + IsActive      │    │ + CategoryId(FK)│
└─────────────────┘    │ + MinStockLevel │
         │              │ + IsActive      │
         │              └─────────────────┘
         │                       │
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  ProductPrice   │    │ StockMovement   │    │  MovementType   │
│                 │    │                 │    │                 │
│ + Id (PK)       │    │ + Id (PK)       │───►│ + Id (PK)       │
│ + TenantId (FK) │    │ + TenantId (FK) │    │ + TenantId (FK) │
│ + ProductId(FK) │    │ + ProductId(FK) │    │ + Name          │
│ + PriceType     │    │ + MovementTypeId│    │ + Code          │
│ + UnitPrice     │    │ + Quantity      │    │ + Direction     │
│ + SupplierId(FK)│    │ + Reference     │    │ + IsActive      │
│ + EffectiveDate │    │ + Notes         │    │ + IsSystemDef   │
│ + IsCurrentPrice│    │ + CreatedAt     │    │ + CreatedAt     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2.2 Core Entities

#### 2.2.1 Base Entity Classes

```csharp
// Her entity için ortak base class
public abstract class TenantEntity
{
    public string TenantId { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }
    public bool IsActive { get; set; } = true;
}

// Tenant tablosu (multi-tenancy için)
public class Tenant
{
    public string Id { get; set; } // PK - subdomain as ID
    public string Name { get; set; }
    public string SubDomain { get; set; }
    public bool IsActive { get; set; }
    public DateTime CreatedAt { get; set; }
    
    // Navigation Properties
    public ICollection<User> Users { get; set; }
    public ICollection<Product> Products { get; set; }
}
```

#### 2.2.2 User Management & Authorization

```csharp
// Rol tanımları
public enum UserRole
{
    SystemAdmin = 1,    // Tüm sistem yönetimi (Super admin)
    TenantAdmin = 2,    // Tenant içinde tam yetki (Dükkan sahibi)
    Manager = 3,        // Stok hareket tipleri dahil yönetim yetkisi
    Employee = 4,       // Sadece stok giriş/çıkış
    ReadOnly = 5        // Sadece görüntüleme
}

// Yetki tablosu
public class Permission : TenantEntity
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string Code { get; set; } // "MANAGE_MOVEMENT_TYPES", "CREATE_STOCK_MOVEMENT"
    public string? Description { get; set; }
    public string Module { get; set; } // "Stock", "Product", "User", "Settings"
    
    // Navigation Properties
    public ICollection<RolePermission> RolePermissions { get; set; }
}

// Rol-Yetki ilişki tablosu
public class RolePermission : TenantEntity
{
    public int Id { get; set; }
    public UserRole Role { get; set; }
    public int PermissionId { get; set; }
    
    // Navigation Properties
    public Permission Permission { get; set; }
}

public class User : TenantEntity
{
    public int Id { get; set; }
    public string Email { get; set; }
    public string PasswordHash { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public UserRole Role { get; set; } = UserRole.TenantAdmin;
    public bool IsActive { get; set; } = true;
    public DateTime? LastLoginAt { get; set; }
    
    // Navigation Properties
    public Tenant Tenant { get; set; }
    
    // Helper Methods
    public bool HasPermission(string permissionCode) => 
        GetPermissionsForRole(Role).Any(p => p.Code == permissionCode);
        
    public bool CanManageMovementTypes() => 
        Role == UserRole.SystemAdmin || 
        Role == UserRole.TenantAdmin || 
        Role == UserRole.Manager;
}
```

#### 2.2.3 Product Catalog

```csharp
public class Category : TenantEntity
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string? Description { get; set; }
    public int? ParentCategoryId { get; set; } // Self-referencing for hierarchy
    
    // Navigation Properties
    public Category? ParentCategory { get; set; }
    public ICollection<Category> SubCategories { get; set; }
    public ICollection<Product> Products { get; set; }
}

public class Product : TenantEntity
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string SKU { get; set; }
    public string? Barcode { get; set; }
    public int CategoryId { get; set; }
    public int MinStockLevel { get; set; } = 0; // Minimum stok seviyesi
    public string? Description { get; set; }
    
    // Navigation Properties
    public Category Category { get; set; }
    public ICollection<StockMovement> StockMovements { get; set; }
    public ICollection<ProductPrice> ProductPrices { get; set; }
    
    // Computed Property - Parametrik hesaplama
    public int CurrentStock => StockMovements
        .Where(sm => sm.IsActive)
        .Sum(sm => sm.CalculatedQuantity);
}
```

#### 2.2.4 Supplier Management

```csharp
public class Supplier : TenantEntity
{
    public int Id { get; set; }
    public string Name { get; set; }
    public string? ContactPerson { get; set; }
    public string? Phone { get; set; }
    public string? Email { get; set; }
    public string? Address { get; set; }
    public string? Notes { get; set; }
    
    // Navigation Properties
    public ICollection<ProductPrice> PurchasePrices { get; set; }
}

// Fiyat tipi enum
public enum PriceType
{
    Purchase = 1,    // Alış fiyatı
    Sale = 2,        // Satış fiyatı
    Wholesale = 3,   // Toptan satış
    Retail = 4       // Perakende satış
}

// Generic fiyat yönetimi tablosu
public class ProductPrice : TenantEntity
{
    public int Id { get; set; }
    public int ProductId { get; set; }
    public PriceType PriceType { get; set; }
    public decimal UnitPrice { get; set; }
    public int? Quantity { get; set; } // Minimum miktar (toptan için)
    public decimal? TotalPrice { get; set; } // Toplam fiyat (lot alımları için)
    
    // Purchase için zorunlu
    public int? SupplierId { get; set; } // Alış fiyatları için tedarikçi
    public string? SupplierProductCode { get; set; } // Tedarikçinin ürün kodu
    
    // Sale için opsiyonel
    public string? CustomerSegment { get; set; } // "VIP", "Normal", "Wholesale"
    public DateTime EffectiveDate { get; set; } // Fiyat geçerlilik tarihi
    public DateTime? ExpiryDate { get; set; } // Fiyat bitiş tarihi
    
    public string? Notes { get; set; }
    public bool IsCurrentPrice { get; set; } = true; // Güncel fiyat mı?
    
    // Navigation Properties
    public Product Product { get; set; }
    public Supplier? Supplier { get; set; }
}

// Price Management Service
public interface IPriceService
{
    Task<ProductPrice> SetPurchasePriceAsync(int productId, int supplierId, decimal unitPrice, int? quantity = null);
    Task<ProductPrice> SetSalePriceAsync(int productId, decimal unitPrice, string? customerSegment = null);
    Task<decimal?> GetCurrentPurchasePriceAsync(int productId, int? supplierId = null);
    Task<decimal?> GetCurrentSalePriceAsync(int productId, string? customerSegment = null);
    Task<List<ProductPrice>> GetPriceHistoryAsync(int productId, PriceType priceType);
}

public class PriceService : IPriceService
{
    private readonly StockDbContext _context;
    private readonly IAuthorizationService _authService;
    
    public async Task<ProductPrice> SetPurchasePriceAsync(int productId, int supplierId, decimal unitPrice, int? quantity = null)
    {
        var currentUser = await _authService.GetCurrentUserAsync();
        AuthorizationHelper.EnsureCanManageMovementTypes(currentUser);
        
        // Önceki fiyatları deaktif et
        var existingPrices = await _context.ProductPrices
            .Where(pp => pp.ProductId == productId && 
                        pp.PriceType == PriceType.Purchase && 
                        pp.SupplierId == supplierId &&
                        pp.IsCurrentPrice)
            .ToListAsync();
            
        foreach (var price in existingPrices)
        {
            price.IsCurrentPrice = false;
        }
        
        // Yeni fiyat ekle
        var newPrice = new ProductPrice
        {
            ProductId = productId,
            PriceType = PriceType.Purchase,
            UnitPrice = unitPrice,
            Quantity = quantity,
            SupplierId = supplierId,
            EffectiveDate = DateTime.UtcNow,
            IsCurrentPrice = true,
            TenantId = currentUser.TenantId
        };
        
        _context.ProductPrices.Add(newPrice);
        await _context.SaveChangesAsync();
        
        return newPrice;
    }
    
    public async Task<decimal?> GetCurrentPurchasePriceAsync(int productId, int? supplierId = null)
    {
        var query = _context.ProductPrices
            .Where(pp => pp.ProductId == productId && 
                        pp.PriceType == PriceType.Purchase && 
                        pp.IsCurrentPrice);
                        
        if (supplierId.HasValue)
        {
            query = query.Where(pp => pp.SupplierId == supplierId);
        }
        
        return await query.OrderByDescending(pp => pp.EffectiveDate)
                         .Select(pp => pp.UnitPrice)
                         .FirstOrDefaultAsync();
    }
}
```

**Kullanım Örnekleri:**

```csharp
// Alış fiyatı belirleme (Tedarikçiden mal alırken)
await _priceService.SetPurchasePriceAsync(
    productId: 123, 
    supplierId: 456, 
    unitPrice: 50.00m, 
    quantity: 100 // 100 adetlik lot
);

// Satış fiyatı belirleme (Farklı müşteri segmentleri için)
await _priceService.SetSalePriceAsync(
    productId: 123, 
    unitPrice: 75.00m, 
    customerSegment: "Normal"
);

await _priceService.SetSalePriceAsync(
    productId: 123, 
    unitPrice: 65.00m, 
    customerSegment: "VIP"
);

// Fiyat sorgulama
var purchasePrice = await _priceService.GetCurrentPurchasePriceAsync(123, 456);
var salePrice = await _priceService.GetCurrentSalePriceAsync(123, "VIP");
```

#### 2.2.5 Stock Movement Configuration

```csharp
// Parametrik hareket tipi yapılandırması
public class MovementType : TenantEntity
{
    public int Id { get; set; }
    public string Name { get; set; } // "Mal Alımı", "Satış", "Fire", "Sayım Düzeltmesi"
    public string Code { get; set; } // "IN", "OUT", "ADJUSTMENT_PLUS", "ADJUSTMENT_MINUS"
    public int Direction { get; set; } // +1 (artış), -1 (azalış)
    public string? Description { get; set; }
    public bool IsActive { get; set; } = true;
    public bool IsSystemDefined { get; set; } = false; // Sistem tanımlı olanlar silinemez
    public bool RequiresManagerApproval { get; set; } = false; // Büyük hareketler için onay
    public int? CreatedByUserId { get; set; } // Kim oluşturdu
    
    // Navigation Properties
    public ICollection<StockMovement> StockMovements { get; set; }
    public User? CreatedByUser { get; set; }
}

// Enum for quick reference (system-defined types)
public enum SystemMovementTypes
{
    Purchase = 1,      // +1 Direction
    Sale = 2,          // -1 Direction  
    Loss = 3,          // -1 Direction
    Found = 4,         // +1 Direction
    Return = 5,        // +1 Direction
    Damage = 6         // -1 Direction
}
```

#### 2.2.6 Stock Management

```csharp
public class StockMovement : TenantEntity
{
    public int Id { get; set; }
    public int ProductId { get; set; }
    public int Quantity { get; set; } // Her zaman pozitif değer
    public int MovementTypeId { get; set; } // FK to MovementType
    public string? Reference { get; set; } // Fatura no, sipariş no, vs.
    public string? Notes { get; set; }
    public decimal? UnitPrice { get; set; } // Hareket anındaki birim fiyat
    public int? SupplierId { get; set; } // Giriş hareketlerinde tedarikçi
    
    // Navigation Properties
    public Product Product { get; set; }
    public MovementType MovementType { get; set; }
    public Supplier? Supplier { get; set; }
    
    // Computed Property - Direction ile çarpılmış miktar
    public int CalculatedQuantity => Quantity * MovementType.Direction;
}
```

### 2.2.7 Authorization Service

```csharp
// Yetkilendirme servisi
public interface IAuthorizationService
{
    Task<bool> CanUserManageMovementTypesAsync(int userId);
    Task<bool> CanUserCreateStockMovementAsync(int userId, int movementTypeId);
    Task<bool> CanUserViewReportsAsync(int userId);
    Task<bool> HasPermissionAsync(int userId, string permissionCode);
    Task<User> GetCurrentUserAsync();
    Task<List<Permission>> GetUserPermissionsAsync(int userId);
}

public class AuthorizationService : IAuthorizationService
{
    private readonly StockDbContext _context;
    private readonly ICurrentUserService _currentUser;
    
    public async Task<bool> CanUserManageMovementTypesAsync(int userId)
    {
        var user = await _context.Users.FindAsync(userId);
        return user?.CanManageMovementTypes() ?? false;
    }
    
    // Movement type yönetimi için yetki kontrolü
    public async Task<bool> CanUserCreateStockMovementAsync(int userId, int movementTypeId)
    {
        var user = await _context.Users.FindAsync(userId);
        var movementType = await _context.MovementTypes.FindAsync(movementTypeId);
        
        if (user == null || movementType == null) return false;
        
        // Sistem tanımlı hareket tipleri için özel kontrol
        if (movementType.IsSystemDefined && user.Role < UserRole.Manager)
            return false;
            
        // Manager approval gerektiren hareketler
        if (movementType.RequiresManagerApproval && user.Role < UserRole.Manager)
            return false;
            
        return true;
    }
}

// Simple authorization exception
public class UnauthorizedException : Exception
{
    public UnauthorizedException(string message) : base(message) { }
}

// Simple authorization helper for services
public static class AuthorizationHelper
{
    public static void EnsureCanManageMovementTypes(User user)
    {
        if (!user.CanManageMovementTypes())
            throw new UnauthorizedException("Hareket tipi yönetme yetkiniz yok.");
    }
    
    public static void EnsureCanCreateStockMovement(User user, MovementType movementType)
    {
        if (movementType.IsSystemDefined && user.Role < UserRole.Manager)
            throw new UnauthorizedException("Bu hareket tipini kullanma yetkiniz yok.");
            
        if (movementType.RequiresManagerApproval && user.Role < UserRole.Manager)
            throw new UnauthorizedException("Bu işlem için manager onayı gereklidir.");
    }
}

// Permission constants
public static class Permissions
{
    public const string MANAGE_MOVEMENT_TYPES = "MANAGE_MOVEMENT_TYPES";
    public const string CREATE_STOCK_MOVEMENT = "CREATE_STOCK_MOVEMENT";
    public const string VIEW_REPORTS = "VIEW_REPORTS";
    public const string MANAGE_USERS = "MANAGE_USERS";
    public const string MANAGE_PRODUCTS = "MANAGE_PRODUCTS";
    public const string MANAGE_SUPPLIERS = "MANAGE_SUPPLIERS";
}
```

### 2.2.8 Stock Calculation Utilities

```csharp
// Stok hesaplamaları için utility service
public interface IStockCalculationService
{
    Task<int> GetCurrentStockAsync(int productId);
    Task<decimal> GetStockValueAsync(int productId);
    Task<List<StockMovementSummary>> GetStockHistoryAsync(int productId, DateTime? from = null, DateTime? to = null);
    Task<bool> ValidateStockMovementAsync(int productId, int movementTypeId, int quantity);
}

// Movement Type Management Service
public interface IMovementTypeService
{
    Task<MovementType> CreateMovementTypeAsync(CreateMovementTypeDto dto);
    Task<MovementType> UpdateMovementTypeAsync(int id, UpdateMovementTypeDto dto);
    Task<bool> DeleteMovementTypeAsync(int id);
    Task<List<MovementType>> GetMovementTypesAsync();
}

public class StockCalculationService : IStockCalculationService
{
    private readonly StockDbContext _context;
    private readonly IAuthorizationService _authService;
    
    public async Task<int> GetCurrentStockAsync(int productId)
    {
        // Basit yetki kontrolü
        var currentUser = await _authService.GetCurrentUserAsync();
        
        // ReadOnly ve üstü herkes görebilir
        if (currentUser.Role < UserRole.ReadOnly)
            throw new UnauthorizedException("Stok bilgilerini görme yetkiniz yok.");
        
        return await _context.StockMovements
            .Where(sm => sm.ProductId == productId && sm.IsActive)
            .Include(sm => sm.MovementType)
            .SumAsync(sm => sm.CalculatedQuantity);
    }
    
    public async Task<decimal> GetStockValueAsync(int productId)
    {
        var movements = await _context.StockMovements
            .Where(sm => sm.ProductId == productId && sm.IsActive && sm.UnitPrice.HasValue)
            .Include(sm => sm.MovementType)
            .ToListAsync();
            
        // FIFO, LIFO veya Weighted Average hesaplama mantığı
        return CalculateWeightedAverageValue(movements);
    }
    
    private decimal CalculateWeightedAverageValue(List<StockMovement> movements)
    {
        // Weighted average cost hesaplama
        decimal totalValue = 0;
        int totalQuantity = 0;
        
        foreach (var movement in movements.Where(m => m.MovementType.Direction > 0)) // Sadece giriş hareketleri
        {
            if (movement.UnitPrice.HasValue)
            {
                totalValue += movement.Quantity * movement.UnitPrice.Value;
                totalQuantity += movement.Quantity;
            }
        }
        
        return totalQuantity > 0 ? totalValue / totalQuantity : 0;
    }
}

// Movement Type Service Implementation
public class MovementTypeService : IMovementTypeService
{
    private readonly StockDbContext _context;
    private readonly IAuthorizationService _authService;
    
    public async Task<MovementType> CreateMovementTypeAsync(CreateMovementTypeDto dto)
    {
        var currentUser = await _authService.GetCurrentUserAsync();
        
        // Basit yetki kontrolü
        AuthorizationHelper.EnsureCanManageMovementTypes(currentUser);
        
        var movementType = new MovementType
        {
            Name = dto.Name,
            Code = dto.Code,
            Direction = dto.Direction,
            Description = dto.Description,
            RequiresManagerApproval = dto.RequiresManagerApproval,
            CreatedByUserId = currentUser.Id,
            TenantId = currentUser.TenantId
        };
        
        _context.MovementTypes.Add(movementType);
        await _context.SaveChangesAsync();
        
        return movementType;
    }
    
    public async Task<bool> DeleteMovementTypeAsync(int id)
    {
        var currentUser = await _authService.GetCurrentUserAsync();
        
        // Basit yetki kontrolü
        AuthorizationHelper.EnsureCanManageMovementTypes(currentUser);
        
        var movementType = await _context.MovementTypes.FindAsync(id);
        
        if (movementType == null)
            throw new NotFoundException("Hareket tipi bulunamadı.");
            
        if (movementType.IsSystemDefined)
            throw new InvalidOperationException("Sistem tanımlı hareket tipleri silinemez.");
            
        // Kullanılmış mı kontrol et
        var hasMovements = await _context.StockMovements
            .AnyAsync(sm => sm.MovementTypeId == id);
            
        if (hasMovements)
        {
            // Soft delete
            movementType.IsActive = false;
        }
        else
        {
            // Hard delete
            _context.MovementTypes.Remove(movementType);
        }
        
        await _context.SaveChangesAsync();
        return true;
    }
}

// DTOs
public class CreateMovementTypeDto
{
    public string Name { get; set; }
    public string Code { get; set; }
    public int Direction { get; set; }
    public string? Description { get; set; }
    public bool RequiresManagerApproval { get; set; }
}

// DTO for reporting
public class StockMovementSummary
{
    public DateTime Date { get; set; }
    public string MovementTypeName { get; set; }
    public int Quantity { get; set; }
    public int Direction { get; set; }
    public int RunningTotal { get; set; }
    public decimal? UnitPrice { get; set; }
    public string? Reference { get; set; }
}
```

### 2.3 Database Configuration

#### 2.3.1 Global Query Filters

```csharp
public class StockDbContext : DbContext
{
    private readonly ICurrentTenantService _currentTenant;
    
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        // Global query filters for tenant isolation
        modelBuilder.Entity<Product>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<User>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<Category>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<Supplier>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<StockMovement>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<MovementType>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<Permission>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<RolePermission>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
            
        modelBuilder.Entity<ProductPrice>()
            .HasQueryFilter(e => e.TenantId == _currentTenant.TenantId);
    }
}
```

#### 2.3.2 Key Performance Considerations

```sql
-- Critical Indexes for Performance
CREATE INDEX IX_Product_TenantId_SKU ON Products (TenantId, SKU);
CREATE INDEX IX_StockMovement_TenantId_ProductId_CreatedAt ON StockMovements (TenantId, ProductId, CreatedAt);
CREATE INDEX IX_Product_TenantId_CategoryId ON Products (TenantId, CategoryId);
CREATE INDEX IX_SupplierProduct_TenantId_ProductId ON SupplierProducts (TenantId, ProductId);
```

### 2.4 Data Migration Strategy

#### 2.4.1 Initial Migration
- Tenant tablosu oluştur
- Base entities oluştur
- Global query filters ekle
- Seed data (varsayılan kategoriler)

#### 2.4.2 Tenant Onboarding
```csharp
public async Task CreateTenantAsync(string tenantId, string tenantName)
{
    // 1. Tenant kaydı oluştur
    var tenant = new Tenant 
    { 
        Id = tenantId, 
        Name = tenantName,
        SubDomain = tenantId 
    };
    
    // 2. Default kategoriler oluştur
    var defaultCategories = new List<Category>
    {
        new() { Name = "Genel", TenantId = tenantId },
        new() { Name = "Elektronik", TenantId = tenantId },
        new() { Name = "Giyim", TenantId = tenantId }
    };
    
    // 3. Default hareket tipleri oluştur
    var defaultMovementTypes = new List<MovementType>
    {
        new() { Id = 1, Name = "Mal Alımı", Code = "PURCHASE", Direction = 1, TenantId = tenantId, IsSystemDefined = true },
        new() { Id = 2, Name = "Satış", Code = "SALE", Direction = -1, TenantId = tenantId, IsSystemDefined = true },
        new() { Id = 3, Name = "Fire/Kayıp", Code = "LOSS", Direction = -1, TenantId = tenantId, IsSystemDefined = true },
        new() { Id = 4, Name = "Bulunan Ürün", Code = "FOUND", Direction = 1, TenantId = tenantId, IsSystemDefined = true },
        new() { Id = 5, Name = "Müşteri İadesi", Code = "RETURN", Direction = 1, TenantId = tenantId, IsSystemDefined = true },
        new() { Id = 6, Name = "Hasarlı Ürün", Code = "DAMAGE", Direction = -1, TenantId = tenantId, IsSystemDefined = true }
    };
    
    // 4. Default yetkiler oluştur
    var defaultPermissions = new List<Permission>
    {
        new() { Name = "Hareket Tiplerini Yönet", Code = "MANAGE_MOVEMENT_TYPES", Module = "Stock", TenantId = tenantId },
        new() { Name = "Stok Hareketi Oluştur", Code = "CREATE_STOCK_MOVEMENT", Module = "Stock", TenantId = tenantId },
        new() { Name = "Raporları Görüntüle", Code = "VIEW_REPORTS", Module = "Reports", TenantId = tenantId },
        new() { Name = "Kullanıcı Yönetimi", Code = "MANAGE_USERS", Module = "Users", TenantId = tenantId },
        new() { Name = "Ürün Yönetimi", Code = "MANAGE_PRODUCTS", Module = "Products", TenantId = tenantId },
        new() { Name = "Tedarikçi Yönetimi", Code = "MANAGE_SUPPLIERS", Module = "Suppliers", TenantId = tenantId }
    };
    
    // 5. Rol-Yetki ilişkileri oluştur
    var rolePermissions = new List<RolePermission>
    {
        // TenantAdmin - Tüm yetkiler
        new() { Role = UserRole.TenantAdmin, PermissionId = 1, TenantId = tenantId },
        new() { Role = UserRole.TenantAdmin, PermissionId = 2, TenantId = tenantId },
        new() { Role = UserRole.TenantAdmin, PermissionId = 3, TenantId = tenantId },
        new() { Role = UserRole.TenantAdmin, PermissionId = 4, TenantId = tenantId },
        new() { Role = UserRole.TenantAdmin, PermissionId = 5, TenantId = tenantId },
        new() { Role = UserRole.TenantAdmin, PermissionId = 6, TenantId = tenantId },
        
        // Manager - Hareket tipleri + operasyonel yetkiler
        new() { Role = UserRole.Manager, PermissionId = 1, TenantId = tenantId },
        new() { Role = UserRole.Manager, PermissionId = 2, TenantId = tenantId },
        new() { Role = UserRole.Manager, PermissionId = 3, TenantId = tenantId },
        new() { Role = UserRole.Manager, PermissionId = 5, TenantId = tenantId },
        
        // Employee - Sadece stok hareketleri
        new() { Role = UserRole.Employee, PermissionId = 2, TenantId = tenantId },
        new() { Role = UserRole.Employee, PermissionId = 3, TenantId = tenantId }
    };
    
    // 6. Default admin user oluştur
    var adminUser = new User 
    { 
        TenantId = tenantId,
        Email = "admin@" + tenantId + ".com",
        Role = UserRole.TenantAdmin,
        FirstName = "Admin",
        LastName = "User"
    };
}
```

## 3. API Design

### 3.1 RESTful API Architecture

#### 3.1.1 Base URL Structure
```
Production: https://{tenant}.stokapp.com/api/v1
Development: https://localhost:5000/api/v1
```

#### 3.1.2 Authentication & Tenant Resolution Flow
```csharp
public class TenantMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        // 1. Extract tenant from subdomain
        var host = context.Request.Host.Host;
        var tenantId = ExtractTenantFromHost(host); // "mehmet.stokapp.com" -> "mehmet"
        
        // 2. Validate tenant exists
        var tenant = await _tenantService.GetTenantAsync(tenantId);
        if (tenant == null || !tenant.IsActive)
        {
            context.Response.StatusCode = 404;
            await context.Response.WriteAsync("Tenant not found");
            return;
        }
        
        // 3. Set tenant context
        context.Items["TenantId"] = tenantId;
        context.Items["Tenant"] = tenant;
        
        await next(context);
    }
}

[ApiController]
[Route("api/v1/[controller]")]
[Authorize] // JWT/Cookie authentication
public abstract class BaseController : ControllerBase
{
    protected string TenantId => HttpContext.Items["TenantId"]?.ToString();
    protected Tenant CurrentTenant => HttpContext.Items["Tenant"] as Tenant;
}
```

### 3.2 Core API Endpoints

#### 3.2.1 Authentication & User Management

```csharp
[Route("api/v1/auth")]
public class AuthController : ControllerBase
{
    /// <summary>
    /// Tenant registration (System Admin only)
    /// </summary>
    [HttpPost("register-tenant")]
    [AllowAnonymous]
    public async Task<IActionResult> RegisterTenant([FromBody] RegisterTenantRequest request)
    {
        var result = await _authService.RegisterTenantAsync(request);
        return Ok(new { TenantId = result.TenantId, AdminUser = result.AdminUser });
    }
    
    /// <summary>
    /// User login for specific tenant
    /// </summary>
    [HttpPost("login")]
    [AllowAnonymous]
    public async Task<IActionResult> Login([FromBody] LoginRequest request)
    {
        var result = await _authService.LoginAsync(request.Email, request.Password, TenantId);
        return Ok(new { Token = result.Token, User = result.User });
    }
    
    /// <summary>
    /// Get current user profile
    /// </summary>
    [HttpGet("profile")]
    public async Task<IActionResult> GetProfile()
    {
        var user = await _authService.GetCurrentUserAsync();
        return Ok(user);
    }
}

// DTOs
public class RegisterTenantRequest
{
    public string TenantId { get; set; }
    public string TenantName { get; set; }
    public string AdminEmail { get; set; }
    public string AdminPassword { get; set; }
}

public class LoginRequest
{
    public string Email { get; set; }
    public string Password { get; set; }
}
```

#### 3.2.2 Product Management

```csharp
[Route("api/v1/products")]
public class ProductsController : BaseController
{
    /// <summary>
    /// Get all products with pagination and filtering
    /// </summary>
    [HttpGet]
    public async Task<IActionResult> GetProducts(
        [FromQuery] int page = 1, 
        [FromQuery] int pageSize = 20,
        [FromQuery] string? search = null,
        [FromQuery] int? categoryId = null)
    {
        var result = await _productService.GetProductsAsync(page, pageSize, search, categoryId);
        return Ok(result);
    }
    
    /// <summary>
    /// Get product by ID with current stock
    /// </summary>
    [HttpGet("{id}")]
    public async Task<IActionResult> GetProduct(int id)
    {
        var product = await _productService.GetProductAsync(id);
        if (product == null) return NotFound();
        
        var currentStock = await _stockService.GetCurrentStockAsync(id);
        var prices = await _priceService.GetCurrentPricesAsync(id);
        
        return Ok(new ProductDetailResponse 
        { 
            Product = product, 
            CurrentStock = currentStock,
            Prices = prices
        });
    }
    
    /// <summary>
    /// Create new product
    /// </summary>
    [HttpPost]
    public async Task<IActionResult> CreateProduct([FromBody] CreateProductRequest request)
    {
        var product = await _productService.CreateProductAsync(request);
        return CreatedAtAction(nameof(GetProduct), new { id = product.Id }, product);
    }
    
    /// <summary>
    /// Update product
    /// </summary>
    [HttpPut("{id}")]
    public async Task<IActionResult> UpdateProduct(int id, [FromBody] UpdateProductRequest request)
    {
        var product = await _productService.UpdateProductAsync(id, request);
        return Ok(product);
    }
    
    /// <summary>
    /// Delete product (soft delete)
    /// </summary>
    [HttpDelete("{id}")]
    public async Task<IActionResult> DeleteProduct(int id)
    {
        await _productService.DeleteProductAsync(id);
        return NoContent();
    }
}

// DTOs
public class CreateProductRequest
{
    public string Name { get; set; }
    public string SKU { get; set; }
    public string? Barcode { get; set; }
    public int CategoryId { get; set; }
    public int MinStockLevel { get; set; }
    public string? Description { get; set; }
}

public class ProductDetailResponse
{
    public Product Product { get; set; }
    public int CurrentStock { get; set; }
    public List<ProductPriceDto> Prices { get; set; }
}
```

#### 3.2.3 Stock Movement Management

```csharp
[Route("api/v1/stock-movements")]
public class StockMovementsController : BaseController
{
    /// <summary>
    /// Create stock movement (IN/OUT/ADJUSTMENT)
    /// </summary>
    [HttpPost]
    public async Task<IActionResult> CreateStockMovement([FromBody] CreateStockMovementRequest request)
    {
        var movement = await _stockService.CreateStockMovementAsync(request);
        return CreatedAtAction(nameof(GetStockMovement), new { id = movement.Id }, movement);
    }
    
    /// <summary>
    /// Get stock movement by ID
    /// </summary>
    [HttpGet("{id}")]
    public async Task<IActionResult> GetStockMovement(int id)
    {
        var movement = await _stockService.GetStockMovementAsync(id);
        if (movement == null) return NotFound();
        return Ok(movement);
    }
    
    /// <summary>
    /// Get stock movements for a product
    /// </summary>
    [HttpGet("product/{productId}")]
    public async Task<IActionResult> GetProductStockMovements(
        int productId,
        [FromQuery] DateTime? from = null,
        [FromQuery] DateTime? to = null,
        [FromQuery] int page = 1,
        [FromQuery] int pageSize = 50)
    {
        var movements = await _stockService.GetProductStockMovementsAsync(
            productId, from, to, page, pageSize);
        return Ok(movements);
    }
    
    /// <summary>
    /// Get current stock levels for all products
    /// </summary>
    [HttpGet("current-levels")]
    public async Task<IActionResult> GetCurrentStockLevels()
    {
        var stockLevels = await _stockService.GetCurrentStockLevelsAsync();
        return Ok(stockLevels);
    }
    
    /// <summary>
    /// Get low stock products
    /// </summary>
    [HttpGet("low-stock")]
    public async Task<IActionResult> GetLowStockProducts()
    {
        var lowStockProducts = await _stockService.GetLowStockProductsAsync();
        return Ok(lowStockProducts);
    }
}

// DTOs
public class CreateStockMovementRequest
{
    public int ProductId { get; set; }
    public int MovementTypeId { get; set; }
    public int Quantity { get; set; }
    public string? Reference { get; set; }
    public string? Notes { get; set; }
    public decimal? UnitPrice { get; set; }
    public int? SupplierId { get; set; }
}

public class StockLevelDto
{
    public int ProductId { get; set; }
    public string ProductName { get; set; }
    public string SKU { get; set; }
    public int CurrentStock { get; set; }
    public int MinStockLevel { get; set; }
    public bool IsLowStock => CurrentStock <= MinStockLevel;
}
```

#### 3.2.4 Movement Type Management

```csharp
[Route("api/v1/movement-types")]
public class MovementTypesController : BaseController
{
    /// <summary>
    /// Get all movement types
    /// </summary>
    [HttpGet]
    public async Task<IActionResult> GetMovementTypes()
    {
        var movementTypes = await _movementTypeService.GetMovementTypesAsync();
        return Ok(movementTypes);
    }
    
    /// <summary>
    /// Create custom movement type (Manager+ only)
    /// </summary>
    [HttpPost]
    public async Task<IActionResult> CreateMovementType([FromBody] CreateMovementTypeRequest request)
    {
        var movementType = await _movementTypeService.CreateMovementTypeAsync(request);
        return CreatedAtAction(nameof(GetMovementType), new { id = movementType.Id }, movementType);
    }
    
    /// <summary>
    /// Get movement type by ID
    /// </summary>
    [HttpGet("{id}")]
    public async Task<IActionResult> GetMovementType(int id)
    {
        var movementType = await _movementTypeService.GetMovementTypeAsync(id);
        if (movementType == null) return NotFound();
        return Ok(movementType);
    }
    
    /// <summary>
    /// Update movement type (Manager+ only)
    /// </summary>
    [HttpPut("{id}")]
    public async Task<IActionResult> UpdateMovementType(int id, [FromBody] UpdateMovementTypeRequest request)
    {
        var movementType = await _movementTypeService.UpdateMovementTypeAsync(id, request);
        return Ok(movementType);
    }
    
    /// <summary>
    /// Delete movement type (Manager+ only)
    /// </summary>
    [HttpDelete("{id}")]
    public async Task<IActionResult> DeleteMovementType(int id)
    {
        await _movementTypeService.DeleteMovementTypeAsync(id);
        return NoContent();
    }
}

// DTOs
public class CreateMovementTypeRequest
{
    public string Name { get; set; }
    public string Code { get; set; }
    public int Direction { get; set; } // +1 or -1
    public string? Description { get; set; }
    public bool RequiresManagerApproval { get; set; }
}
```

#### 3.2.5 Price Management

```csharp
[Route("api/v1/prices")]
public class PricesController : BaseController
{
    /// <summary>
    /// Set purchase price for a product from supplier
    /// </summary>
    [HttpPost("purchase")]
    public async Task<IActionResult> SetPurchasePrice([FromBody] SetPurchasePriceRequest request)
    {
        var price = await _priceService.SetPurchasePriceAsync(
            request.ProductId, request.SupplierId, request.UnitPrice, request.Quantity);
        return Ok(price);
    }
    
    /// <summary>
    /// Set sale price for a product
    /// </summary>
    [HttpPost("sale")]
    public async Task<IActionResult> SetSalePrice([FromBody] SetSalePriceRequest request)
    {
        var price = await _priceService.SetSalePriceAsync(
            request.ProductId, request.UnitPrice, request.CustomerSegment);
        return Ok(price);
    }
    
    /// <summary>
    /// Get current prices for a product
    /// </summary>
    [HttpGet("product/{productId}")]
    public async Task<IActionResult> GetProductPrices(int productId)
    {
        var prices = await _priceService.GetCurrentPricesAsync(productId);
        return Ok(prices);
    }
    
    /// <summary>
    /// Get price history for a product
    /// </summary>
    [HttpGet("product/{productId}/history")]
    public async Task<IActionResult> GetPriceHistory(int productId, [FromQuery] PriceType? priceType = null)
    {
        var history = await _priceService.GetPriceHistoryAsync(productId, priceType);
        return Ok(history);
    }
}

// DTOs
public class SetPurchasePriceRequest
{
    public int ProductId { get; set; }
    public int SupplierId { get; set; }
    public decimal UnitPrice { get; set; }
    public int? Quantity { get; set; }
}

public class SetSalePriceRequest
{
    public int ProductId { get; set; }
    public decimal UnitPrice { get; set; }
    public string? CustomerSegment { get; set; }
}
```

### 3.3 Error Handling & Response Standards

#### 3.3.1 Global Error Handling

```csharp
public class GlobalExceptionMiddleware
{
    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        try
        {
            await next(context);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(context, ex);
        }
    }
    
    private static async Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        var response = new ApiErrorResponse();
        
        switch (exception)
        {
            case UnauthorizedException unauthorizedException:
                response.StatusCode = 403;
                response.Message = unauthorizedException.Message;
                break;
                
            case NotFoundException notFoundException:
                response.StatusCode = 404;
                response.Message = notFoundException.Message;
                break;
                
            case ValidationException validationException:
                response.StatusCode = 400;
                response.Message = "Validation failed";
                response.Errors = validationException.Errors;
                break;
                
            default:
                response.StatusCode = 500;
                response.Message = "An internal server error occurred";
                break;
        }
        
        context.Response.StatusCode = response.StatusCode;
        context.Response.ContentType = "application/json";
        
        await context.Response.WriteAsync(JsonSerializer.Serialize(response));
    }
}

public class ApiErrorResponse
{
    public int StatusCode { get; set; }
    public string Message { get; set; }
    public Dictionary<string, string[]>? Errors { get; set; }
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;
}
```

#### 3.3.2 Standard Response Formats

```csharp
// Success Response
public class ApiResponse<T>
{
    public bool Success { get; set; } = true;
    public T Data { get; set; }
    public string? Message { get; set; }
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;
}

// Paginated Response
public class PagedResponse<T> : ApiResponse<T>
{
    public int Page { get; set; }
    public int PageSize { get; set; }
    public int TotalItems { get; set; }
    public int TotalPages { get; set; }
    public bool HasNext { get; set; }
    public bool HasPrevious { get; set; }
}
```

### 3.4 Validation & DTOs

#### 3.4.1 Input Validation

```csharp
public class CreateProductRequestValidator : AbstractValidator<CreateProductRequest>
{
    public CreateProductRequestValidator()
    {
        RuleFor(x => x.Name)
            .NotEmpty().WithMessage("Ürün adı gereklidir")
            .MaximumLength(200).WithMessage("Ürün adı maksimum 200 karakter olabilir");
            
        RuleFor(x => x.SKU)
            .NotEmpty().WithMessage("SKU gereklidir")
            .MaximumLength(50).WithMessage("SKU maksimum 50 karakter olabilir");
            
        RuleFor(x => x.CategoryId)
            .GreaterThan(0).WithMessage("Geçerli bir kategori seçiniz");
            
        RuleFor(x => x.MinStockLevel)
            .GreaterThanOrEqualTo(0).WithMessage("Minimum stok seviyesi 0 veya daha büyük olmalıdır");
    }
}

public class CreateStockMovementRequestValidator : AbstractValidator<CreateStockMovementRequest>
{
    public CreateStockMovementRequestValidator()
    {
        RuleFor(x => x.ProductId)
            .GreaterThan(0).WithMessage("Geçerli bir ürün seçiniz");
            
        RuleFor(x => x.MovementTypeId)
            .GreaterThan(0).WithMessage("Geçerli bir hareket tipi seçiniz");
            
        RuleFor(x => x.Quantity)
            .GreaterThan(0).WithMessage("Miktar 0'dan büyük olmalıdır");
            
        RuleFor(x => x.UnitPrice)
            .GreaterThan(0).When(x => x.UnitPrice.HasValue)
            .WithMessage("Birim fiyat 0'dan büyük olmalıdır");
    }
}
```

### 3.5 API Documentation (Swagger)

```csharp
// Startup.cs or Program.cs
services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo 
    { 
        Title = "Stok Takip API", 
        Version = "v1",
        Description = "KOBİ'ler için stok takip sistemi API'si"
    });
    
    // JWT Authentication
    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header using the Bearer scheme",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.Http,
        Scheme = "bearer"
    });
    
    c.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            new string[] {}
        }
    });
});
```

## 4. Security & Performance

### 4.1 Security Measures

#### 4.1.1 Authentication & Authorization

```csharp
// JWT Configuration
services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = "StokApp",
            ValidAudience = "StokApp",
            IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(secretKey)),
            ClockSkew = TimeSpan.Zero
        };
    });

// CORS Policy
services.AddCors(options =>
{
    options.AddPolicy("TenantPolicy", builder =>
    {
        builder.WithOrigins("https://*.stokapp.com")
               .AllowAnyMethod()
               .AllowAnyHeader()
               .AllowCredentials();
    });
});
```

#### 4.1.2 Data Protection

```csharp
// Global Query Filters ensure tenant isolation
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    // Automatic tenant filtering
    foreach (var entityType in modelBuilder.Model.GetEntityTypes())
    {
        if (typeof(TenantEntity).IsAssignableFrom(entityType.ClrType))
        {
            var parameter = Expression.Parameter(entityType.ClrType, "e");
            var property = Expression.Property(parameter, nameof(TenantEntity.TenantId));
            var filter = Expression.Equal(property, Expression.Constant(_currentTenant.TenantId));
            var lambda = Expression.Lambda(filter, parameter);
            
            modelBuilder.Entity(entityType.ClrType).HasQueryFilter(lambda);
        }
    }
}
```

### 4.2 Performance Optimizations

#### 4.2.1 Database Optimizations

```sql
-- Critical indexes for MVP
CREATE INDEX IX_Product_TenantId_SKU ON Products (TenantId, SKU);
CREATE INDEX IX_Product_TenantId_CategoryId ON Products (TenantId, CategoryId);
CREATE INDEX IX_StockMovement_TenantId_ProductId_CreatedAt ON StockMovements (TenantId, ProductId, CreatedAt);
CREATE INDEX IX_ProductPrice_TenantId_ProductId_PriceType_IsCurrentPrice ON ProductPrices (TenantId, ProductId, PriceType, IsCurrentPrice);
CREATE INDEX IX_MovementType_TenantId_IsActive ON MovementTypes (TenantId, IsActive);
```



### 4.3 API Rate Limiting

```csharp
// Simple rate limiting for MVP
services.AddRateLimiter(options =>
{
    options.GlobalLimiter = PartitionedRateLimiter.Create<HttpContext, string>(context =>
        RateLimitPartition.GetFixedWindowLimiter(
            partitionKey: context.Items["TenantId"]?.ToString() ?? "anonymous",
            factory: partition => new FixedWindowRateLimiterOptions
            {
                PermitLimit = 100,
                QueueLimit = 10,
                Window = TimeSpan.FromMinutes(1)
            }));
});
``` 